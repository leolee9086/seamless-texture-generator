# 采样区域编辑器优化计划

## 当前功能概述
- 支持通过拖拽四个角点来定义采样区域
- 支持图像的缩放和平移
- 支持触摸屏的捏合缩放
- 使用透视变换进行图像裁切

## 优化目标

### 1. 保持比例裁切模式
**功能描述**：允许用户在裁切时保持固定的宽高比，如16:9、4:3、1:1等。

**实现方案**：
- 添加比例选择器UI组件，提供常见比例选项（16:9、4:3、1:1、自定义）
- 添加比例锁定开关，启用后拖拽角点时自动保持比例
- 实现比例约束算法：
  - 当拖拽一个角点时，根据固定比例计算其他角点的位置
  - 支持以不同角点为基准进行比例调整（左上、右上、中心等）
- 添加比例预设管理功能，允许用户保存常用比例

**技术细节**：
- 修改`handlePointDragMove`函数，添加比例约束逻辑
- 添加新的状态管理：`aspectRatio`、`aspectRatioLocked`、`aspectRatioAnchor`
- 实现比例计算函数：`calculateConstrainedPoints()`

### 2. 裁切区域旋转功能
**功能描述**：允许用户旋转裁切区域，支持任意角度旋转。

**实现方案**：
- 添加旋转控制UI：
  - 旋转角度输入框（支持精确输入）
  - 旋转滑块（支持快速调整）
  - 旋转重置按钮
- 实现旋转交互：
  - 添加旋转中心点控制（可拖拽调整）
  - 支持通过手势进行旋转（触摸设备）
  - 添加旋转吸附功能（0°、90°、180°、270°）
- 实现旋转算法：
  - 使用矩阵变换实现角点旋转
  - 旋转后自动调整边界，确保裁切区域在图像范围内
  - 支持旋转后的透视变换

**技术细节**：
- 添加旋转状态：`rotation`、`rotationCenter`
- 实现旋转函数：`rotatePoints(points, angle, center)`
- 修改透视变换算法，支持旋转后的坐标变换
- 添加旋转控制UI组件到工具栏

### 3. 用户体验优化
**功能描述**：提升整体用户体验和操作流畅度。

**实现方案**：
- 添加网格和参考线：
  - 可选的网格显示，帮助对齐
  - 中心线和三分线参考
  - 智能参考线（自动吸附到边缘、中心）
- 改进视觉反馈：
  - 拖拽时的实时预览
  - 更明显的控制点悬停效果
  - 操作提示和快捷键说明
- 添加撤销/重做功能：
  - 实现操作历史记录
  - 支持键盘快捷键（Ctrl+Z/Ctrl+Y）
  - 限制历史记录数量，避免内存占用过大

**技术细节**：
- 实现历史管理系统：`HistoryManager`类
- 添加网格渲染：`GridLayer`组件
- 实现吸附算法：`snapToGrid()`、`snapToGuides()`

### 4. 性能优化
**功能描述**：提升大图像处理和交互的性能。

**实现方案**：
- 图像处理优化：
  - 实现图像金字塔，支持多级缩放
  - 大图像的分块加载和处理
  - 使用Web Workers进行透视变换计算
- 渲染优化：
  - 实现视口裁剪，只渲染可见区域
  - 使用Canvas缓存静态元素
  - 优化重绘频率，避免不必要的更新

**技术细节**：
- 实现图像金字塔：`ImagePyramid`类
- 创建Web Worker：`perspective.worker.ts`
- 实现视口裁剪算法

### 5. 高级功能
**功能描述**：添加更多专业级功能。

**实现方案**：
- 批量处理：
  - 支持多图像同时处理
  - 批量应用相同的裁切参数
- 导出选项：
  - 支持多种导出格式（PNG、JPEG、WebP）
  - 导出质量设置
  - 导出尺寸预设
- 集成增强：
  - 与其他编辑组件的集成
  - 支持导入/导出裁切配置

**技术细节**：
- 实现批量处理管理器：`BatchProcessor`
- 添加导出配置：`ExportSettings`
- 实现配置序列化：`serializeSettings()`、`deserializeSettings()`

## 实现优先级
1. **高优先级**：保持比例裁切模式、裁切区域旋转功能
2. **中优先级**：用户体验优化、性能优化
3. **低优先级**：高级功能

## 测试计划
- 单元测试：核心算法（比例约束、旋转变换、透视变换）
- 集成测试：UI交互、图像处理流程
- 性能测试：大图像处理、内存使用
- 兼容性测试：不同设备、浏览器

## 技术栈考虑
- 保持现有Vue 3 + Konva架构
- 考虑引入高质量的外部库：
  - 图像处理：可能考虑使用fabric.js（如果功能需求复杂）
  - 数学计算：可能考虑使用gl-matrix（高性能矩阵运算）
- 确保所有引入的库都经过严格评估，符合性能和质量要求
